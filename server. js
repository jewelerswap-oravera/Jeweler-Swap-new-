const express = require('express');
const cors = require('cors');
const { ethers } = require('ethers');
const multer = require('multer');
require('dotenv').config();

const app = express();
const upload = multer({ storage: multer.memoryStorage() });

app.use(cors());
app.use(express.json());

// ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð±Ð»Ð¾ÐºÑ‡ÐµÐ¹Ð½Ñƒ
const provider = new ethers.JsonRpcProvider(process.env.MUMBAI_RPC_URL);
const contractAddress = process.env.CONTRACT_ADDRESS;
const contractABI = [
  "function requestPassport(string memory _nfcSerial, string memory _ipfsHash, string memory _metadata) public payable returns (uint256)",
  "function verifyPassport(uint256 _tokenId) public",
  "function getPassportByNFC(string memory _nfcSerial) public view returns (tuple(uint256 tokenId, address owner, address verifiedBy, uint256 verifiedAt, string nfcSerial, string ipfsHash, string metadata, bool isActive))",
  "function jewelers(address) public view returns (bool)",
  "function addJeweler(address _jeweler) public",
  "event PassportCreated(uint256 indexed tokenId, address indexed owner, string nfcSerial)",
  "event PassportVerified(uint256 indexed tokenId, address indexed jeweler)"
];

const contract = new ethers.Contract(contractAddress, contractABI, provider);

// ðŸ“Œ API Ð”Ð›Ð¯ ÐŸÐžÐ›Ð¬Ð—ÐžÐ’ÐÐ¢Ð•Ð›Ð•Ð™
app.get('/', (req, res) => {
  res.json({ message: 'JewelerSwap API Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚! ðŸš€' });
});

// 1. Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ NFT-Ð¿Ð°ÑÐ¿Ð¾Ñ€Ñ‚
app.post('/api/passport/request', upload.single('photo'), async (req, res) => {
  try {
    const { nfcSerial, metadata, userAddress } = req.body;
    
    // Ð’ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ð·Ð´ÐµÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð² IPFS
    const ipfsHash = `ipfs://dummy/${nfcSerial}.jpg`;
    
    const wallet = new ethers.Wallet(process.env.PRIVATE_KEY, provider);
    const contractWithSigner = contract.connect(wallet);
    
    const tx = await contractWithSigner.requestPassport(
      nfcSerial,
      ipfsHash,
      metadata,
      { value: ethers.parseEther("0.001") }
    );
    
    await tx.wait();
    res.json({ success: true, txHash: tx.hash, message: "NFT-Ð¿Ð°ÑÐ¿Ð¾Ñ€Ñ‚ ÑÐ¾Ð·Ð´Ð°Ð½" });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});

// 2. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ NFC
app.post('/api/nfc/check', async (req, res) => {
  try {
    const { nfcCode } = req.body;
    const passport = await contract.getPassportByNFC(nfcCode);
    
    res.json({
      success: true,
      passport: {
        tokenId: passport.tokenId.toString(),
        owner: passport.owner,
        verifiedBy: passport.verifiedBy,
        verified: passport.isActive,
        nfcSerial: passport.nfcSerial
      }
    });
  } catch (error) {
    res.json({ success: false, message: "NFC Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½" });
  }
});

// 3. ÐŸÐ°Ð½ÐµÐ»ÑŒ ÑŽÐ²ÐµÐ»Ð¸Ñ€Ð° (Ð²ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ)
app.post('/api/jeweler/verify', async (req, res) => {
  try {
    const { tokenId, jewelerAddress } = req.body;
    
    const wallet = new ethers.Wallet(process.env.JEWELER_KEY, provider);
    const contractWithJeweler = contract.connect(wallet);
    
    const tx = await contractWithJeweler.verifyPassport(tokenId);
    await tx.wait();
    
    res.json({ success: true, message: "ÐŸÐ°ÑÐ¿Ð¾Ñ€Ñ‚ Ð²ÐµÑ€Ð¸Ñ„Ð¸Ñ†Ð¸Ñ€Ð¾Ð²Ð°Ð½!" });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});

// 4. ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð¿Ð°ÑÐ¿Ð¾Ñ€Ñ‚Ð° (ÑƒÐ¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ð¾)
app.get('/api/passports', async (req, res) => {
  res.json({
    success: true,
    passports: [
      { id: 1, nfc: "NFC001", verified: true, type: "ÐºÐ¾Ð»ÑŒÑ†Ð¾" },
      { id: 2, nfc: "NFC002", verified: false, type: "Ñ†ÐµÐ¿Ð¾Ñ‡ÐºÐ°" }
    ]
  });
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½: http://localhost:${PORT}`);
  console.log(`ðŸ”— API: http://localhost:${PORT}/api/passports`);
});
